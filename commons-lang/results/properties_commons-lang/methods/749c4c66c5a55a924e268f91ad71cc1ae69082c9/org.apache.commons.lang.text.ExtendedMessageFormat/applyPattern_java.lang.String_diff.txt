/**                                                                                                    /**                                                                                                 
* Apply the specified pattern.                                                                         * Apply the specified pattern.                                                                      
*                                                                                                      *                                                                                                   
* @param pattern String                                                                                * @param pattern String                                                                             
*/                                                                                                     */                                                                                                  
@Override                                                                                              @Override                                                                                           
public final void applyPattern(String pattern) {                                                       public final void applyPattern(String pattern) {                                                    
if (registry == null) {                                                                                if (registry == null) {                                                                             
super.applyPattern(pattern);                                                                           super.applyPattern(pattern);                                                                        
toPattern = super.toPattern();                                                                         toPattern = super.toPattern();                                                                      
return;                                                                                                return;                                                                                             
}                                                                                                      }                                                                                                   
ArrayList&lt;Format&gt; foundFormats = new ArrayList&lt;Format&gt;();                                  ArrayList&lt;Format&gt; foundFormats = new ArrayList&lt;Format&gt;();                               
ArrayList&lt;String&gt; foundDescriptions = new ArrayList&lt;String&gt;();                             ArrayList&lt;String&gt; foundDescriptions = new ArrayList&lt;String&gt;();                          
StringBuffer stripCustom = new StringBuffer(pattern.length());                                       | StringBuilder stripCustom = new StringBuilder(pattern.length());                                    
ParsePosition pos = new ParsePosition(0);                                                              ParsePosition pos = new ParsePosition(0);                                                           
char[] c = pattern.toCharArray();                                                                      char[] c = pattern.toCharArray();                                                                   
int fmtCount = 0;                                                                                      int fmtCount = 0;                                                                                   
while (pos.getIndex() &lt; pattern.length()) {                                                         while (pos.getIndex() &lt; pattern.length()) {                                                      
switch(c[pos.getIndex()]) {                                                                            switch(c[pos.getIndex()]) {                                                                         
case QUOTE:                                                                                            case QUOTE:                                                                                         
appendQuotedString(pattern, pos, stripCustom, true);                                                   appendQuotedString(pattern, pos, stripCustom, true);                                                
break;                                                                                                 break;                                                                                              
case START_FE:                                                                                         case START_FE:                                                                                      
fmtCount++;                                                                                            fmtCount++;                                                                                         
seekNonWs(pattern, pos);                                                                               seekNonWs(pattern, pos);                                                                            
int start = pos.getIndex();                                                                            int start = pos.getIndex();                                                                         
int index = readArgumentIndex(pattern, next(pos));                                                     int index = readArgumentIndex(pattern, next(pos));                                                  
stripCustom.append(START_FE).append(index);                                                            stripCustom.append(START_FE).append(index);                                                         
seekNonWs(pattern, pos);                                                                               seekNonWs(pattern, pos);                                                                            
Format format = null;                                                                                  Format format = null;                                                                               
String formatDescription = null;                                                                       String formatDescription = null;                                                                    
if (c[pos.getIndex()] == START_FMT) {                                                                  if (c[pos.getIndex()] == START_FMT) {                                                               
formatDescription = parseFormatDescription(pattern, next(pos));                                        formatDescription = parseFormatDescription(pattern, next(pos));                                     
format = getFormat(formatDescription);                                                                 format = getFormat(formatDescription);                                                              
if (format == null) {                                                                                  if (format == null) {                                                                               
stripCustom.append(START_FMT).append(formatDescription);                                               stripCustom.append(START_FMT).append(formatDescription);                                            
}                                                                                                      }                                                                                                   
}                                                                                                      }                                                                                                   
foundFormats.add(format);                                                                              foundFormats.add(format);                                                                           
foundDescriptions.add(format == null ? null : formatDescription);                                      foundDescriptions.add(format == null ? null : formatDescription);                                   
Validate.isTrue(foundFormats.size() == fmtCount);                                                      Validate.isTrue(foundFormats.size() == fmtCount);                                                   
Validate.isTrue(foundDescriptions.size() == fmtCount);                                                 Validate.isTrue(foundDescriptions.size() == fmtCount);                                              
if (c[pos.getIndex()] != END_FE) {                                                                     if (c[pos.getIndex()] != END_FE) {                                                                  
throw new IllegalArgumentException("Unreadable format element at position " + start);                  throw new IllegalArgumentException("Unreadable format element at position " + start);               
}                                                                                                      }                                                                                                   
// fall through                                                                                      | // $FALL-THROUGH$                                                                                   
default:                                                                                               default:                                                                                            
stripCustom.append(c[pos.getIndex()]);                                                                 stripCustom.append(c[pos.getIndex()]);                                                              
next(pos);                                                                                             next(pos);                                                                                          
}                                                                                                      }                                                                                                   
}                                                                                                      }                                                                                                   
super.applyPattern(stripCustom.toString());                                                            super.applyPattern(stripCustom.toString());                                                         
toPattern = insertFormats(super.toPattern(), foundDescriptions);                                       toPattern = insertFormats(super.toPattern(), foundDescriptions);                                    
if (containsElements(foundFormats)) {                                                                  if (containsElements(foundFormats)) {                                                               
Format[] origFormats = getFormats();                                                                   Format[] origFormats = getFormats();                                                                
// only loop over what we know we have, as MessageFormat on Java 1.3                                   // only loop over what we know we have, as MessageFormat on Java 1.3                                
// seems to provide an extra format element:                                                           // seems to provide an extra format element:                                                        
int i = 0;                                                                                             int i = 0;                                                                                          
for (Iterator&lt;Format&gt; it = foundFormats.iterator(); it.hasNext(); i++) {                         for (Iterator&lt;Format&gt; it = foundFormats.iterator(); it.hasNext(); i++) {                      
Format f = it.next();                                                                                  Format f = it.next();                                                                               
if (f != null) {                                                                                       if (f != null) {                                                                                    
origFormats[i] = f;                                                                                    origFormats[i] = f;                                                                                 
}                                                                                                      }                                                                                                   
}                                                                                                      }                                                                                                   
super.setFormats(origFormats);                                                                         super.setFormats(origFormats);                                                                      
}                                                                                                      }                                                                                                   
}                                                                                                      }                                                                                                   
