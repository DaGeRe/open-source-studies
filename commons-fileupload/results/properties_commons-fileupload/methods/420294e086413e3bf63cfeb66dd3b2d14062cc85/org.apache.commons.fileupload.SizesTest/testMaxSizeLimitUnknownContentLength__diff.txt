@Test                                                                                                  @Test                                                                                               
public void testMaxSizeLimitUnknownContentLength() throws IOException, FileUploadException {           public void testMaxSizeLimitUnknownContentLength() throws IOException, FileUploadException {        
final String request = "-----1234\r\n" + "Content-Disposition: form-data; name=\"file1\"; filename=\   final String request = "-----1234\r\n" + "Content-Disposition: form-data; name=\"file1\"; filename=\
ServletFileUpload upload = new ServletFileUpload(new DiskFileItemFactory());                           ServletFileUpload upload = new ServletFileUpload(new DiskFileItemFactory());                        
upload.setFileSizeMax(-1);                                                                             upload.setFileSizeMax(-1);                                                                          
upload.setSizeMax(300);                                                                                upload.setSizeMax(300);                                                                             
// the first item should be within the max size limit                                                  // the first item should be within the max size limit                                               
// set the read limit to 10 to simulate a "real" stream                                                // set the read limit to 10 to simulate a "real" stream                                             
// otherwise the buffer would be immediately filled                                                    // otherwise the buffer would be immediately filled                                                 
MockHttpServletRequest req = new MockHttpServletRequest(request.getBytes("US-ASCII"), CONTENT_TYPE);   MockHttpServletRequest req = new MockHttpServletRequest(request.getBytes("US-ASCII"), CONTENT_TYPE);
req.setContentLength(-1);                                                                              req.setContentLength(-1);                                                                           
req.setReadLimit(10);                                                                                  req.setReadLimit(10);                                                                               
FileItemIterator it = upload.getItemIterator(req);                                                     FileItemIterator it = upload.getItemIterator(req);                                                  
assertTrue(it.hasNext());                                                                              assertTrue(it.hasNext());                                                                           
FileItemStream item = it.next();                                                                       FileItemStream item = it.next();                                                                    
assertFalse(item.isFormField());                                                                       assertFalse(item.isFormField());                                                                    
assertEquals("file1", item.getFieldName());                                                            assertEquals("file1", item.getFieldName());                                                         
assertEquals("foo1.tab", item.getName());                                                              assertEquals("foo1.tab", item.getName());                                                           
{                                                                                                      {                                                                                                   
                                                                                                     | // Streams.copy closes the input file                                                               
                                                                                                     | @SuppressWarnings("resource")                                                                       
InputStream stream = item.openStream();                                                                InputStream stream = item.openStream();                                                             
ByteArrayOutputStream baos = new ByteArrayOutputStream();                                              ByteArrayOutputStream baos = new ByteArrayOutputStream();                                           
// Streams.copy closes the input file                                                                |                                                                                                     
Streams.copy(stream, baos, true);                                                                      Streams.copy(stream, baos, true);                                                                   
}                                                                                                      }                                                                                                   
// the second item is over the size max, thus we expect an error                                       // the second item is over the size max, thus we expect an error                                    
try {                                                                                                  try {                                                                                               
// the header is still within size max -&gt; this shall still succeed                                  // the header is still within size max -&gt; this shall still succeed                               
assertTrue(it.hasNext());                                                                              assertTrue(it.hasNext());                                                                           
} catch (SizeException e) {                                                                            } catch (SizeException e) {                                                                         
fail();                                                                                                fail();                                                                                             
}                                                                                                      }                                                                                                   
item = it.next();                                                                                      item = it.next();                                                                                   
try {                                                                                                  try {                                                                                               
                                                                                                     | // Streams.copy closes the input file                                                               
                                                                                                     | @SuppressWarnings("resource")                                                                       
InputStream stream = item.openStream();                                                                InputStream stream = item.openStream();                                                             
ByteArrayOutputStream baos = new ByteArrayOutputStream();                                              ByteArrayOutputStream baos = new ByteArrayOutputStream();                                           
// Streams.copy closes the input file                                                                |                                                                                                     
Streams.copy(stream, baos, true);                                                                      Streams.copy(stream, baos, true);                                                                   
fail();                                                                                                fail();                                                                                             
} catch (FileUploadIOException e) {                                                                    } catch (FileUploadIOException e) {                                                                 
// expected                                                                                            // expected                                                                                         
}                                                                                                      }                                                                                                   
}                                                                                                      }                                                                                                   
