                                                                                                     | private String calculateHttpEncoding(String httpContentType, String bomEnc, String xmlGuessEnc, Stri
                                                                                                     | String cTMime = getContentTypeMime(httpContentType);                                                
                                                                                                     | String cTEnc = getContentTypeEncoding(httpContentType);                                             
                                                                                                     | String encoding;                                                                                    
                                                                                                     | if (lenient & xmlEnc != null) {                                                                     
                                                                                                     | encoding = xmlEnc;                                                                                  
                                                                                                     | } else {                                                                                            
                                                                                                     | boolean appXml = isAppXml(cTMime);                                                                  
                                                                                                     | boolean textXml = isTextXml(cTMime);                                                                
                                                                                                     | if (appXml || textXml) {                                                                            
                                                                                                     | if (cTEnc == null) {                                                                                
                                                                                                     | if (appXml) {                                                                                       
                                                                                                     | encoding = calculateRawEncoding(bomEnc, xmlGuessEnc, xmlEnc);                                       
                                                                                                     | } else {                                                                                            
                                                                                                     | encoding = (defaultEncoding == null) ? US_ASCII : defaultEncoding;                                  
                                                                                                     | }                                                                                                   
                                                                                                     | } else if (bomEnc != null && (cTEnc.equals(UTF_16BE) || cTEnc.equals(UTF_16LE))) {                  
                                                                                                     | String msg = MessageFormat.format(HTTP_EX_1, cTMime, cTEnc, bomEnc, xmlGuessEnc, xmlEnc);           
                                                                                                     | throw new XmlStreamReaderException(msg, cTMime, cTEnc, bomEnc, xmlGuessEnc, xmlEnc);                
                                                                                                     | } else if (cTEnc.equals(UTF_16)) {                                                                  
                                                                                                     | if (bomEnc != null && bomEnc.startsWith(UTF_16)) {                                                  
                                                                                                     | encoding = bomEnc;                                                                                  
                                                                                                     | } else {                                                                                            
                                                                                                     | String msg = MessageFormat.format(HTTP_EX_2, cTMime, cTEnc, bomEnc, xmlGuessEnc, xmlEnc);           
                                                                                                     | throw new XmlStreamReaderException(msg, cTMime, cTEnc, bomEnc, xmlGuessEnc, xmlEnc);                
                                                                                                     | }                                                                                                   
                                                                                                     | } else {                                                                                            
                                                                                                     | encoding = cTEnc;                                                                                   
                                                                                                     | }                                                                                                   
                                                                                                     | } else {                                                                                            
                                                                                                     | String msg = MessageFormat.format(HTTP_EX_3, cTMime, cTEnc, bomEnc, xmlGuessEnc, xmlEnc);           
                                                                                                     | throw new XmlStreamReaderException(msg, cTMime, cTEnc, bomEnc, xmlGuessEnc, xmlEnc);                
                                                                                                     | }                                                                                                   
                                                                                                     | }                                                                                                   
                                                                                                     | return encoding;                                                                                    
                                                                                                     | }                                                                                                   
