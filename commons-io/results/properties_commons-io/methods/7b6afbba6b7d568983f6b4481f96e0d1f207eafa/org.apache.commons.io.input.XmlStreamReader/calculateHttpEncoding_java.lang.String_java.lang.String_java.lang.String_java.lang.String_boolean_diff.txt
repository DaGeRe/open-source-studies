private String calculateHttpEncoding(String httpContentType, String bomEnc, String xmlGuessEnc, Stri   private String calculateHttpEncoding(String httpContentType, String bomEnc, String xmlGuessEnc, Stri
                                                                                                     | if (lenient && xmlEnc != null) {                                                                    
                                                                                                     | return xmlEnc;                                                                                      
                                                                                                     | }                                                                                                   
String cTMime = getContentTypeMime(httpContentType);                                                   String cTMime = getContentTypeMime(httpContentType);                                                
String cTEnc = getContentTypeEncoding(httpContentType);                                                String cTEnc = getContentTypeEncoding(httpContentType);                                             
String encoding;                                                                                     |                                                                                                     
if (lenient & xmlEnc != null) {                                                                      |                                                                                                     
encoding = xmlEnc;                                                                                   |                                                                                                     
} else {                                                                                             |                                                                                                     
boolean appXml = isAppXml(cTMime);                                                                     boolean appXml = isAppXml(cTMime);                                                                  
boolean textXml = isTextXml(cTMime);                                                                   boolean textXml = isTextXml(cTMime);                                                                
if (appXml || textXml) {                                                                             | if (!appXml && !textXml) {                                                                          
                                                                                                     | String msg = MessageFormat.format(HTTP_EX_3, cTMime, cTEnc, bomEnc, xmlGuessEnc, xmlEnc);           
                                                                                                     | throw new XmlStreamReaderException(msg, cTMime, cTEnc, bomEnc, xmlGuessEnc, xmlEnc);                
                                                                                                     | }                                                                                                   
if (cTEnc == null) {                                                                                   if (cTEnc == null) {                                                                                
if (appXml) {                                                                                          if (appXml) {                                                                                       
encoding = calculateRawEncoding(bomEnc, xmlGuessEnc, xmlEnc);                                        | return calculateRawEncoding(bomEnc, xmlGuessEnc, xmlEnc);                                           
} else {                                                                                               } else {                                                                                            
encoding = (defaultEncoding == null) ? US_ASCII : defaultEncoding;                                   | return (defaultEncoding == null) ? US_ASCII : defaultEncoding;                                      
}                                                                                                      }                                                                                                   
} else if (bomEnc != null && (cTEnc.equals(UTF_16BE) || cTEnc.equals(UTF_16LE))) {                   | }                                                                                                   
                                                                                                     | if (cTEnc.equals(UTF_16BE) || cTEnc.equals(UTF_16LE)) {                                             
                                                                                                     | if (bomEnc != null) {                                                                               
String msg = MessageFormat.format(HTTP_EX_1, cTMime, cTEnc, bomEnc, xmlGuessEnc, xmlEnc);              String msg = MessageFormat.format(HTTP_EX_1, cTMime, cTEnc, bomEnc, xmlGuessEnc, xmlEnc);           
throw new XmlStreamReaderException(msg, cTMime, cTEnc, bomEnc, xmlGuessEnc, xmlEnc);                   throw new XmlStreamReaderException(msg, cTMime, cTEnc, bomEnc, xmlGuessEnc, xmlEnc);                
} else if (cTEnc.equals(UTF_16)) {                                                                   | }                                                                                                   
                                                                                                     | return cTEnc;                                                                                       
                                                                                                     | }                                                                                                   
                                                                                                     | if (cTEnc.equals(UTF_16)) {                                                                         
if (bomEnc != null && bomEnc.startsWith(UTF_16)) {                                                     if (bomEnc != null && bomEnc.startsWith(UTF_16)) {                                                  
encoding = bomEnc;                                                                                   | return bomEnc;                                                                                      
} else {                                                                                             | }                                                                                                   
String msg = MessageFormat.format(HTTP_EX_2, cTMime, cTEnc, bomEnc, xmlGuessEnc, xmlEnc);              String msg = MessageFormat.format(HTTP_EX_2, cTMime, cTEnc, bomEnc, xmlGuessEnc, xmlEnc);           
throw new XmlStreamReaderException(msg, cTMime, cTEnc, bomEnc, xmlGuessEnc, xmlEnc);                   throw new XmlStreamReaderException(msg, cTMime, cTEnc, bomEnc, xmlGuessEnc, xmlEnc);                
}                                                                                                      }                                                                                                   
} else {                                                                                             | return cTEnc;                                                                                       
encoding = cTEnc;                                                                                    |                                                                                                     
}                                                                                                      }                                                                                                   
} else {                                                                                             |                                                                                                     
String msg = MessageFormat.format(HTTP_EX_3, cTMime, cTEnc, bomEnc, xmlGuessEnc, xmlEnc);            |                                                                                                     
throw new XmlStreamReaderException(msg, cTMime, cTEnc, bomEnc, xmlGuessEnc, xmlEnc);                 |                                                                                                     
}                                                                                                    |                                                                                                     
}                                                                                                    |                                                                                                     
return encoding;                                                                                     |                                                                                                     
}                                                                                                    |                                                                                                     
