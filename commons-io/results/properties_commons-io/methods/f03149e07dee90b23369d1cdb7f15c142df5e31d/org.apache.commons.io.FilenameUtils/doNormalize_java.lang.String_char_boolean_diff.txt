private static String doNormalize(final String filename, final char separator, final boolean keepSep   private static String doNormalize(final String filename, final char separator, final boolean keepSep
if (filename == null) {                                                                                if (filename == null) {                                                                             
return null;                                                                                           return null;                                                                                        
}                                                                                                      }                                                                                                   
failIfNullBytePresent(filename);                                                                       failIfNullBytePresent(filename);                                                                    
int size = filename.length();                                                                          int size = filename.length();                                                                       
if (size == 0) {                                                                                       if (size == 0) {                                                                                    
return filename;                                                                                       return filename;                                                                                    
}                                                                                                      }                                                                                                   
final int prefix = getPrefixLength(filename);                                                          final int prefix = getPrefixLength(filename);                                                       
if (prefix &lt; 0) {                                                                                   if (prefix &lt; 0) {                                                                                
return null;                                                                                           return null;                                                                                        
}                                                                                                      }                                                                                                   
final char[] array = new char[size + 2];                                                               final char[] array = new char[size + 2];                                                            
filename.getChars(0, filename.length(), array, 0);                                                     filename.getChars(0, filename.length(), array, 0);                                                  
final char otherSeparator = separator == SYSTEM_SEPARATOR ? OTHER_SEPARATOR : SYSTEM_SEPARATOR;        final char otherSeparator = separator == SYSTEM_SEPARATOR ? OTHER_SEPARATOR : SYSTEM_SEPARATOR;     
for (int i = 0; i &lt; array.length; i++) {                                                            for (int i = 0; i &lt; array.length; i++) {                                                         
if (array[i] == otherSeparator) {                                                                      if (array[i] == otherSeparator) {                                                                   
array[i] = separator;                                                                                  array[i] = separator;                                                                               
}                                                                                                      }                                                                                                   
}                                                                                                      }                                                                                                   
boolean lastIsDirectory = true;                                                                        boolean lastIsDirectory = true;                                                                     
if (array[size - 1] != separator) {                                                                    if (array[size - 1] != separator) {                                                                 
array[size++] = separator;                                                                             array[size++] = separator;                                                                          
lastIsDirectory = false;                                                                               lastIsDirectory = false;                                                                            
}                                                                                                      }                                                                                                   
for (int i = prefix + 1; i &lt; size; i++) {                                                           for (int i = prefix + 1; i &lt; size; i++) {                                                        
if (array[i] == separator && array[i - 1] == separator) {                                              if (array[i] == separator && array[i - 1] == separator) {                                           
System.arraycopy(array, i, array, i - 1, size - i);                                                    System.arraycopy(array, i, array, i - 1, size - i);                                                 
size--;                                                                                                size--;                                                                                             
i--;                                                                                                   i--;                                                                                                
}                                                                                                      }                                                                                                   
}                                                                                                      }                                                                                                   
for (int i = prefix + 1; i &lt; size; i++) {                                                           for (int i = prefix + 1; i &lt; size; i++) {                                                        
if (array[i] == separator && array[i - 1] == '.' && (i == prefix + 1 || array[i - 2] == separator))    if (array[i] == separator && array[i - 1] == '.' && (i == prefix + 1 || array[i - 2] == separator)) 
if (i == size - 1) {                                                                                   if (i == size - 1) {                                                                                
lastIsDirectory = true;                                                                                lastIsDirectory = true;                                                                             
}                                                                                                      }                                                                                                   
System.arraycopy(array, i + 1, array, i - 1, size - i);                                                System.arraycopy(array, i + 1, array, i - 1, size - i);                                             
size -= 2;                                                                                             size -= 2;                                                                                          
i--;                                                                                                   i--;                                                                                                
}                                                                                                      }                                                                                                   
}                                                                                                      }                                                                                                   
outer: for (int i = prefix + 2; i &lt; size; i++) {                                                    outer: for (int i = prefix + 2; i &lt; size; i++) {                                                 
if (array[i] == separator && array[i - 1] == '.' && array[i - 2] == '.' && (i == prefix + 2 || array   if (array[i] == separator && array[i - 1] == '.' && array[i - 2] == '.' && (i == prefix + 2 || array
if (i == prefix + 2) {                                                                                 if (i == prefix + 2) {                                                                              
return null;                                                                                           return null;                                                                                        
}                                                                                                      }                                                                                                   
if (i == size - 1) {                                                                                   if (i == size - 1) {                                                                                
lastIsDirectory = true;                                                                                lastIsDirectory = true;                                                                             
}                                                                                                      }                                                                                                   
int j;                                                                                                 int j;                                                                                              
for (j = i - 4; j &gt;= prefix; j--) {                                                                 for (j = i - 4; j &gt;= prefix; j--) {                                                              
if (array[j] == separator) {                                                                           if (array[j] == separator) {                                                                        
System.arraycopy(array, i + 1, array, j + 1, size - i);                                                System.arraycopy(array, i + 1, array, j + 1, size - i);                                             
size -= i - j;                                                                                         size -= i - j;                                                                                      
i = j + 1;                                                                                             i = j + 1;                                                                                          
continue outer;                                                                                        continue outer;                                                                                     
}                                                                                                      }                                                                                                   
}                                                                                                      }                                                                                                   
System.arraycopy(array, i + 1, array, prefix, size - i);                                               System.arraycopy(array, i + 1, array, prefix, size - i);                                            
size -= i + 1 - prefix;                                                                                size -= i + 1 - prefix;                                                                             
i = prefix + 1;                                                                                        i = prefix + 1;                                                                                     
}                                                                                                      }                                                                                                   
}                                                                                                      }                                                                                                   
if (size &lt;= 0) {                                                                                    if (size &lt;= 0) {                                                                                 
return "";                                                                                           | return EMPTY_STRING;                                                                                
}                                                                                                      }                                                                                                   
if (size &lt;= prefix) {                                                                               if (size &lt;= prefix) {                                                                            
return new String(array, 0, size);                                                                     return new String(array, 0, size);                                                                  
}                                                                                                      }                                                                                                   
if (lastIsDirectory && keepSeparator) {                                                                if (lastIsDirectory && keepSeparator) {                                                             
return new String(array, 0, size);                                                                     return new String(array, 0, size);                                                                  
}                                                                                                      }                                                                                                   
return new String(array, 0, size - 1);                                                                 return new String(array, 0, size - 1);                                                              
}                                                                                                      }                                                                                                   
